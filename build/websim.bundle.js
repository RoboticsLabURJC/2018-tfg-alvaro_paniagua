!function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="/build/",i(i.s=2)}([function(module,__webpack_exports__,__webpack_require__){"use strict";function startStopCode(play,myRobot,reservedVariables,mainInterval,getCode,arg){var image=document.getElementById("runbtn").firstChild;if(play)image.src="assets/resources/play-icon.png",clearInterval(mainInterval),myRobot.move(0,0),play=!1,console.log("Execution stopped.");else{image.src="assets/resources/stop-icon.png";var content=null,demoWorkspace=arg;content=eval(getCode),content=cleanRedefinition(content,reservedVariables),play=!0,eval(content)}return{play:play,mainInterval:mainInterval}}function cleanRedefinition(t,e){var i=t.split("\n"),r=i[0].split(" ");return e.forEach((t,e)=>{var i=r.indexOf(t);-1!=i&&(r[i]=0==e||1==e?"":"dummyVariable;")}),i[0]=r.join(" "),i.join("\n")}__webpack_require__.d(__webpack_exports__,"a",function(){return startStopCode})},,function(t,e,i){"use strict";i.r(e);var r,s,n,a,o={schema:{canvas:{type:"string",default:""},fps:{type:"number",default:30}},init:function(){$(document).ready(()=>{var t=document.querySelector(this.data.canvas);this.counter=0,this.renderer=new THREE.WebGLRenderer({antialias:!0,preserveDrawingBuffer:!0}),this.renderer.id="robotCam",this.renderer.setPixelRatio(window.devicePixelRatio),this.renderer.setSize(t.offsetWidth,t.offsetHeight),t.appendChild(this.renderer.domElement),t.style.display="none",this.canvas2d=document.createElement("canvas"),this.canvas2d.id="camera2",this.canvas2d.width=this.renderer.domElement.width,this.canvas2d.height=this.renderer.domElement.height,this.canvas2d.style.display="none",t.appendChild(this.canvas2d),this.getCameraInfo()})},tick:function(t,e){var i=1e3/e/this.data.fps,r=Math.round(i);this.counter%r==0&&this.render(e),this.counter+=1},render:function(){this.renderer.render(this.el.sceneEl.object3D,this.el.object3DMap.camera);let t=this.renderer.domElement.toDataURL(),e=this.canvas2d.getContext("2d"),i=new Image;i.onload=function(){e.drawImage(i,0,0)},i.src=t},getCameraInfo:function(){console.log(this.el.object3DMap.camera)}},c={schema:{fps:{type:"number",default:15}},init:function(){this.bindMethods()},tick:function(){if(!((new Date).getTime()-this.lastTick<1e3/this.data.fps)){if(this.isIntersecting){let t=this.el.components.raycaster.getIntersection(this.hittedElem);this.el.emit("intersection-detected-"+this.el.id,t.distance)}else this.el.emit("intersection-cleared-"+this.el.id);this.lastTick=(new Date).getTime()}},bindMethods(){this.onIntersection=this.onIntersection.bind(this),this.onIntersectionClear=this.onIntersectionClear.bind(this)},play:function(){this.registerEventListeners()},pause:function(){this.deregisterEventListeners()},registerEventListeners(){this.el.addEventListener("raycaster-intersection",this.onIntersection),this.el.addEventListener("raycaster-intersection-cleared",this.onIntersectionClear)},deregisterEventListeners(){this.el.removeEventListener("raycaster-intersection",this.onIntersection),this.el.removeEventListener("raycaster-intersection-cleared",this.onIntersectionClear)},onIntersection:function(t){this.isIntersecting=!0,t.detail.els[0]&&(this.hittedElem=t.detail.els[0])},onIntersectionClear:function(t){this.isIntersecting=!1}},l={schema:{entityId:{type:"string",default:""},offsetRotation:{type:"vec3",default:"0 0 0"}},init:function(){this.pibot=document.querySelector(this.data.entityId),this.initialRotation=this.data.offsetRotation.y},tick:function(){let t=this.pibot.object3D.position,e=this.pibot.object3D.rotation,i=e.y+THREE.Math.degToRad(this.initialRotation),r=this.el,s=.38*Math.cos(THREE.Math.radToDeg(e.y)*Math.PI/180),n=.38*Math.sin(THREE.Math.radToDeg(e.y)*Math.PI/180);r.object3D.position.set(t.x+s,t.y+.23,t.z-n),r.object3D.rotation.set(e.x,i,e.z)}},d=i(0),h=!1,u=["myRobot,","mainInterval,","myRobot;","mainInterval;"];AFRAME.registerComponent("spectator",o),AFRAME.registerComponent("intersection-handler",c),AFRAME.registerComponent("follow-body",l),document.addEventListener("body-loaded",t=>{"a-pibot"==t.target.id&&(console.log("------Robot body loaded, creating myRobot instance------"),r=new class{constructor(t){this.myRobotID=t,this.robot=document.getElementById(t),this.activeRays=!1,this.raycastersArray=[],this.distanceArray={center:[],left:[],right:[]},this.understandedColors={blue:{low:[0,0,235,0],high:[0,0,255,255]},green:{low:[0,235,0,0],high:[0,255,0,255]},red:{low:[235,0,0,0],high:[255,0,0,255]},white:{low:[230,230,230,0],high:[255,255,255,255]}},this.velocity={x:0,y:0,z:0,ax:0,ay:0,az:0},this.motorsStarter(this.robot),this.startCamera(),this.startRaycasters(10,31)}motorsStarter(t){console.log("LOG ---------------- Setting up motors."),this.setVelocity(t)}getRotation(){return this.robot.getAttribute("rotation")}setV(t){this.velocity.x=t}setW(t){this.velocity.ay=10*t}setL(t){this.velocity.y=t}move(t,e){this.setV(t),this.setW(e)}getV(){return this.velocity.x}getW(){return this.velocity.ay}getL(){return this.velocity.y}setVelocity(t){void 0!=t&&(this.robot=t);let e=this.getRotation(),i=this.updatePosition(e,this.velocity,this.robot.body.position);this.robot.body.position.set(i.x,i.y,i.z),this.robot.body.angularVelocity.set(this.velocity.ax,this.velocity.ay,this.velocity.az),this.timeoutMotors=setTimeout(this.setVelocity.bind(this),30)}updatePosition(t,e,i){let r=e.x/10*Math.cos(t.y*Math.PI/180),s=e.x/10*Math.sin(t.y*Math.PI/180);return i.x+=r,i.z-=s,i}getCameraDescription(){return{width:this.canvas2d.width,height:this.canvas2d.height}}clearAll(){clearTimeout(this.timeoutCamera),clearTimeout(this.timeoutMotors),clearInterval(this.followLineInterval),this.velocity={x:0,y:0,z:0,ax:0,ay:0,az:0},this.setVelocity(),this.robot.body.position.set(0,0,0)}getImageDescription(){return{width:this.imagedata.cols,height:this.imagedata.rows}}getImageFormat(){return 1}startCamera(){console.log("LOG ---------\x3e Starting camera."),$("#spectatorDiv").length&&void 0!=document.querySelector("#spectatorDiv").firstChild?(this.canvas2d=document.querySelector("#camera2"),this.getImageData_async()):setTimeout(this.startCamera.bind(this),100)}getImage(){if(void 0!=this.imagedata)return this.imagedata;setTimeout(this.getImage.bind(this),200)}getImageData_async(){this.imagedata=cv.imread("camera2"),this.timeoutCamera=setTimeout(this.getImageData_async.bind(this),33)}startRaycasters(t,e){if(this.activeRays)this.stopRaycasters(),this.startRaycasters(t,e);else{console.log("LOG ---------\x3e Starting sound sensors");let a=document.querySelector("#positionSensor");e%2==0&&(e+=1);for(var i=180/e,r=0,s="center",n=0;n<e;n++)n%2==0?(r*=-1,0!=n&&(s="right")):(r*=-1,r+=i,0!=n&&(s="left")),this.createRaycaster(t,r,a,s,n);this.activeRays=!0,this.setListener()}}createRaycaster(t,e,i,r,s){let n=document.createElement("a-entity");n.setAttribute("raycaster","objects",".collidable"),n.setAttribute("raycaster","far",t),n.setAttribute("raycaster","showLine",!0),n.setAttribute("raycaster","direction","1 0 0"),n.setAttribute("raycaster","interval",100),n.setAttribute("raycaster","enabled",!0),n.setAttribute("line","color","#ffffff"),n.setAttribute("line","opacity",0),n.setAttribute("line","end","1 0 0"),n.setAttribute("follow-body","entityId","#"+this.myRobotID),n.setAttribute("follow-body","offsetRotation","0 "+e+" 0"),n.setAttribute("intersection-handler","fps","10"),n.classList.add(r),n.id=s.toString(),this.raycastersArray.push(n),i.appendChild(n)}stopRaycasters(){for(var t=document.querySelector("#positionSensor");t.firstChild;)this.removeListeners(t.firstChild),t.removeChild(t.firstChild);this.activeRays=!1}setListener(){for(var t=0;t<this.raycastersArray.length;t++)this.raycastersArray[t].addEventListener("intersection-detected-"+this.raycastersArray[t].id,this.updateDistance.bind(this)),this.raycastersArray[t].addEventListener("intersection-cleared-"+this.raycastersArray[t].id,this.eraseDistance.bind(this))}removeListeners(t){t.removeEventListener("intersection-detected-"+t.id,()=>{console.log("removed")}),t.removeEventListener("intersection-cleared-"+t.id,()=>{console.log("removed")})}updateDistance(t){let e=t.target.id,i=t.target.classList[0];if(0==this.distanceArray[i].length)this.distanceArray[i].push({id:e,d:t.detail});else{let r=!1,s=0;for(;s<this.distanceArray[i].length&&!r;)this.distanceArray[i][s].id==e&&(this.distanceArray[i][s].d=t.detail,r=!0),s+=1;r||this.distanceArray[i].push({id:e,d:t.detail})}}eraseDistance(t){let e=t.target.id,i=t.target.classList[0];for(var r=0;r<this.distanceArray[i].length;r++)this.distanceArray[i][r].id==e&&this.distanceArray[i].splice(r,1)}getDistance(){return null!=this.distanceArray.center[0]?this.distanceArray.center[0].d:null}getDistances(){for(var t=[],e=["center","right","left"],i=0;i<e.length;i++)this.distanceArray[e[i]].forEach(e=>{t.push(e.d)});return t}getPosition(){return{x:this.robot.object3D.position.x,y:this.robot.object3D.position.y,z:this.robot.object3D.position.z,theta:THREE.Math.radToDeg(this.robot.object3D.rotation.y)}}getObjectColor(t){var e=this.getImage(),i=this.getColorCode(t),r=new cv.Mat,s=(new cv.Mat,cv.Mat.ones(5,5,cv.CV_8U)),n=new cv.Point(-1,-1),a=new cv.Mat(e.rows,e.cols,e.type(),i[0]),o=new cv.Mat(e.rows,e.cols,e.type(),i[1]),c=new cv.MatVector,l=new cv.Mat;if(cv.morphologyEx(e,e,cv.MORPH_OPEN,s,n,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue()),cv.inRange(e,a,o,r),cv.findContours(r,c,l,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE),c.size()>0){let t=c.get(0);var d=cv.contourArea(t,!1);let e=cv.moments(t,!1);var h=e.m10/e.m00,u=e.m01/e.m00}return{center:[parseInt(h),parseInt(u)],area:parseInt(d)}}getObjectColorRGB(t,e){var i=this.getImage(),r=new cv.Mat,s=(new cv.Mat,cv.Mat.ones(5,5,cv.CV_8U)),n=new cv.Point(-1,-1),a=new cv.Mat(i.rows,i.cols,i.type(),t),o=new cv.Mat(i.rows,i.cols,i.type(),e),c=new cv.MatVector,l=new cv.Mat;if(cv.morphologyEx(i,i,cv.MORPH_OPEN,s,n,2,cv.BORDER_CONSTANT,cv.morphologyDefaultBorderValue()),cv.inRange(i,a,o,r),cv.findContours(r,c,l,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE),c.size()>0){let t=c.get(0);var d=cv.contourArea(t,!1);let e=cv.moments(t,!1);var h=e.m10/e.m00,u=e.m01/e.m00}return{center:[parseInt(h),parseInt(u)],area:parseInt(d)}}getColorCode(t){if(this.understandedColors[t])return[this.understandedColors[t].low,this.understandedColors[t].high]}followLine(t,e,i){var r=this.getObjectColorRGB(t,e);this.setV(i),r.center[0]>=75&&r.center[0]<95?this.setW(-.2):r.center[0]<=75&&r.center[0]>=55?this.setW(.2):r.center[0]>=95?this.setW(-.35):r.center[0]<=55&&this.setW(.35)}readIR(t){var e=3,i=this.getImage(),r=new cv.Mat,s=(new cv.Mat,this.getColorCode(t)),n=new cv.MatVector,a=new cv.Mat;let o=new cv.Mat,c=cv.matFromArray(2,3,cv.CV_64FC1,[1,0,0,0,1,-95]),l=new cv.Size(i.cols,i.rows-95);cv.warpAffine(i,o,c,l,cv.INTER_LINEAR,cv.BORDER_CONSTANT,new cv.Scalar);var d=new cv.Mat(o.rows,o.cols,o.type(),s[0]),h=new cv.Mat(o.rows,o.cols,o.type(),s[1]);if(cv.inRange(o,d,h,r),cv.findContours(r,n,a,cv.RETR_CCOMP,cv.CHAIN_APPROX_SIMPLE),n.size()>0){let t=n.get(0),i=cv.moments(t,!1);var u=i.m10/i.m00;e=isNaN(u)?3:u<=150&&u>=93?2:u>=0&&u<=57?1:0}return e}}("a-pibot"))}),document.addEventListener("get-editor-event",t=>{a=t.detail["function-to-call"],n=t.detail.argument}),$(document).ready(()=>{$("#runbtn").click(()=>{var t=Object(d.a)(h,r,u,s,a,n);s=t.mainInterval,h=t.play})})}]);